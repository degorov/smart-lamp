"use strict";(self.webpackChunksmart_lamp=self.webpackChunksmart_lamp||[]).push([[179],{7956:(e,t,a)=>{var n=a(7294),l=a(9060),r=a(1120),s=a(3457),c=a(7850),i=a(1579),o=a(6159),m=a(2692),u=a(6057),d=a(5477),p=a(3832),E=a(5834);const Z=(0,n.createContext)();Z.displayName="ConnectionContext";const g=(0,n.createContext)();g.displayName="ApiContext";var v=a(9895),f=a(4232);const h=5e3,b={ping:async function(e,t){try{return"OK"===(await e(t,{action:"ping"})).error}catch(e){return!1}},geteffects:async function(e,t){try{const a=await e(t,{action:"geteffects"});return"OK"===a.error&&{brightness:+a.brightness,maxbrightness:+a.maxbrightness,index:+a.index,value:+a.value}}catch(e){return!1}},setbrightness:async function(e,t,a){try{return"OK"===(await e(a,{action:"setbrightness",value:t})).error}catch(e){return!1}},seteffect:async function(e,t,a,n){try{return"OK"===(await e(n,{action:"seteffect",index:t,value:a})).error}catch(e){return!1}},getsettings:async function(e,t){try{const a=await e(t,{action:"getsettings"});return"OK"===a.error&&{ssid:a.ssid,password:a.password,timezone:+a.timezone,maxbrightness:+a.maxbrightness}}catch(e){return!1}},savesettings:async function(e,t,a,n,l,r){try{return"OK"===(await e(r,{action:"savesettings",ssid:t,password:a,timezone:n,maxbrightness:l})).error}catch(e){return!1}},getalarm:async function(e,t){try{const a=await e(t,{action:"getalarm"});return"OK"===a.error&&{apmode:!!a.apmode,enabled:!!a.enabled,time:a.time,repeat:+a.repeat,before:+a.before,after:+a.after}}catch(e){return!1}},savealarm:async function(e,t,a,n,l,r,s){try{return"OK"===(await e(s,{action:"savealarm",enabled:+t,repeat:a,time:n,before:l,after:r})).error}catch(e){return!1}}};var w=a(5258),y=a(7812),C=a(8358),x=a(2318),k=a(3375),N=a(739),z=a(5403);const S=(0,r.Z)((e=>({title:{flexGrow:1},save:{marginRight:e.spacing(2)}})));function P({title:e,save:t}){const a=S(),[l]=(0,n.useContext)(Z);return n.createElement(w.Z,{position:"sticky"},n.createElement(C.Z,null,n.createElement(x.Z,{variant:"h6",className:a.title},e||"Светильник"),t?n.createElement(y.Z,{className:a.save,color:"inherit",onClick:t},n.createElement(k.Z,null)):null,l?n.createElement(z.Z,null):n.createElement(N.Z,null)))}var F=a(5881),I=a(8665),O=a(1076),T=a(2832),L=a(9956);const A=(0,r.Z)({root:{width:"100%",position:"fixed",bottom:0,zIndex:100}});function K({page:e,labels:t,setPage:a}){const l=A(),[r]=(0,n.useContext)(Z);return n.createElement(F.Z,{className:l.root,showLabels:!0,value:e,onChange:(e,t)=>{a(t)}},n.createElement(I.Z,{label:t[0],icon:n.createElement(L.Z,null),disabled:!r}),n.createElement(I.Z,{label:t[1],icon:n.createElement(O.Z,null),disabled:!r}),n.createElement(I.Z,{label:t[2],icon:n.createElement(T.Z,null)}))}var D=a(8135),M=a(1201),j=a(743),W=a(1749),_=a(4845),R=a(6447),B=a(7816),G=a(5352),$=a(4566);const H=(0,r.Z)((e=>({slider:{paddingTop:e.spacing(2),paddingBottom:e.spacing(2)},icon:{paddingLeft:e.spacing(2),paddingRight:e.spacing(2)},params:{marginLeft:e.spacing(1),marginRight:e.spacing(1)}})));function V(e,t){return 256*e+t%256}function J(e,t){return 256*Math.floor(t/256)+e}function q({children:e,open:t,value:a}){return n.createElement(R.ZP,{open:t,enterTouchDelay:0,placement:"top",title:a},e)}function Q(){const e=H(),[,t]=(0,n.useContext)(Z),a=(0,n.useContext)(g),[l,r]=(0,n.useState)(16),[s,c]=(0,n.useState)(16),[i,o]=(0,n.useState)({index:0,value:0,save:!1}),m=[0,255,192,10,10,-40,2,5,10,0,34],u=e=>(t,a)=>{o(a?{index:e,value:m[e],save:!0}:{index:0,value:0,save:!0})},d=e=>{o({...i,value:e,save:!1})},p=e=>{o({...i,value:e,save:!0})},E=(0,n.useCallback)((async()=>{const e=await a.geteffects();e?(o({index:e.index,value:e.value,save:!1}),r(e.brightness),c(e.maxbrightness)):t(!1)}),[a,t]);return(0,n.useEffect)((()=>{i.save&&(async()=>{await a.seteffect(i.index,Math.abs(i.value))||t(!1)})()}),[a,t,i]),(0,n.useEffect)((()=>(window.addEventListener("focus",E),E(),()=>{window.removeEventListener("focus",E)})),[E]),n.createElement(n.Fragment,null,n.createElement(W.Z,{container:!0,alignItems:"center",className:e.slider},n.createElement(W.Z,{item:!0,className:e.icon},n.createElement(G.Z,null)),n.createElement(W.Z,{item:!0,xs:!0},n.createElement(_.Z,{min:16,max:s,valueLabelDisplay:"auto",ValueLabelComponent:q,value:l,onChange:(e,t)=>{r(t)},onChangeCommitted:async(e,n)=>{await a.setbrightness(n)||t(!1)}})),n.createElement(W.Z,{item:!0,className:e.icon},n.createElement(B.Z,null))),n.createElement(D.Z,{expanded:1===i.index,onChange:u(1)},n.createElement(j.Z,{expandIcon:n.createElement($.Z,null)},n.createElement(x.Z,null,"Выбранный цвет")),n.createElement(M.Z,{className:e.params},n.createElement(W.Z,{container:!0,spacing:3},n.createElement(W.Z,{item:!0,xs:12},n.createElement(_.Z,{track:!1,min:0,max:255,marks:[{value:0,label:"К"},{value:32,label:"О"},{value:64,label:"Ж"},{value:96,label:"З"},{value:128,label:"Г"},{value:160,label:"С"},{value:192,label:"Ф"},{value:224,label:"Р"},{value:255,label:"К"}],value:Math.floor(i.value/256),onChange:(e,t)=>d(V(t,i.value)),onChangeCommitted:(e,t)=>p(V(t,i.value))})),n.createElement(W.Z,{item:!0,xs:12},n.createElement(_.Z,{track:!1,min:0,max:255,value:i.value%256,onChange:(e,t)=>d(J(t,i.value)),onChangeCommitted:(e,t)=>p(J(t,i.value))}))))),[[2,"Цвета по кругу",0,255],[3,"Вертикальная радуга",0,16],[4,"Горизонтальная радуга",0,16],[5,"Матрица",-150,-5],[6,"Вспышки",1,32],[7,"Светлячки",1,16],[8,"Плазма",5,50],[9,"Пламя",0,255],[10,"Часы",0,255]].map((t=>n.createElement(D.Z,{key:t[0],expanded:i.index===t[0],onChange:u(t[0])},n.createElement(j.Z,{expandIcon:n.createElement($.Z,null)},n.createElement(x.Z,null,t[1])),n.createElement(M.Z,{className:e.params},n.createElement(_.Z,{track:!1,min:t[2],max:t[3],value:i.value,onChange:(e,t)=>d(t),onChangeCommitted:(e,t)=>p(t)}))))))}var U=a(3258),X=a(2822),Y=a(998),ee=a(6869),te=a(1860),ae=a(5757),ne=a(6837),le=a(9570),re=a(9776);const se=(0,r.Z)((e=>({alarmField:{background:e.palette.background.paper,width:150},timeField:{background:e.palette.background.paper,width:75},message:{padding:e.spacing(2)}})));function ce({setSave:e}){const t=se(),[,a]=(0,n.useContext)(Z),l=(0,n.useContext)(g),[r,s]=(0,n.useState)({apmode:!1,enabled:!1,repeat:0,time:"",before:0,after:0}),c=t=>a=>{s({...r,[t]:a.target.value}),e(m)},i=t=>a=>{a.target.checked?s({...r,repeat:1<<6-t|r.repeat}):s({...r,repeat:~(1<<6-t)&r.repeat}),e(m)},o=(0,n.useCallback)((async()=>{const e=await l.getalarm();e?s({apmode:e.apmode,enabled:e.enabled,repeat:e.repeat,time:e.time,before:e.before,after:e.after}):a(!1)}),[l,a]),m=()=>()=>{s((e=>((async()=>{await l.savealarm(e.enabled,e.repeat,e.time,e.before,e.after)||a(!1)})(),e))),e(null)};return(0,n.useEffect)((()=>(window.addEventListener("focus",o),o(),()=>{window.removeEventListener("focus",o),e(null)})),[o,e]),r.apmode?n.createElement(x.Z,{align:"center",className:t.message},"Настройка будильника будет доступна после подключения светильника к сети Wi-Fi с доступом в Интернет для синхронизации с серверами точного времени."):n.createElement(X.Z,null,n.createElement(Y.Z,null,n.createElement(ee.Z,null,n.createElement(O.Z,null)),n.createElement(ae.Z,{primary:"Будильник включен"}),n.createElement(te.Z,null,n.createElement(le.Z,{color:"primary",edge:"end",checked:r.enabled,onChange:t=>{s({...r,enabled:t.target.checked}),e(m)}}))),n.createElement(Y.Z,null,n.createElement(ae.Z,{inset:!0,primary:"Время:"}),n.createElement(re.Z,{id:"alarm-time",type:"time",variant:"outlined",size:"small",className:t.alarmField,inputProps:{step:300},value:r.time,onChange:c("time")})),n.createElement(ne.Z,null,"Повторять по:"),["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"].map(((e,t)=>n.createElement(Y.Z,{dense:!0,button:!0,key:t,disableRipple:!0},n.createElement(ee.Z,null,n.createElement(U.Z,{color:"primary",edge:"start",checked:!!(1<<6-t&r.repeat),onClick:i(t)})),n.createElement(ae.Z,{primary:e})))),n.createElement(ne.Z,null,"Настройки рассвета (в минутах):"),n.createElement(Y.Z,null,n.createElement(ae.Z,{primary:"Рассвет до будильника:"}),n.createElement(te.Z,null,n.createElement(re.Z,{id:"time-before",size:"small",variant:"outlined",className:t.timeField,type:"number",inputProps:{maxLength:2},value:r.before,onChange:c("before")}))),n.createElement(Y.Z,null,n.createElement(ae.Z,{primary:"Гореть после будильника:"}),n.createElement(te.Z,null,n.createElement(re.Z,{id:"time-after",size:"small",variant:"outlined",className:t.timeField,type:"number",inputProps:{maxLength:2},value:r.after,onChange:c("after")}))))}var ie=a(282),oe=a(2663),me=a(6856),ue=a(9525),de=a(7212),pe=a(6083),Ee=a(4436),Ze=a(7397),ge=a(3700),ve=a(5639),fe=a(6718),he=a(7802),be=a(67),we=a(8270),ye=a(9659);function Ce(){return n.createElement(u.Z,{textAlign:"center",p:2},n.createElement("div",null,n.createElement(ye.Z,{target:"_blank",rel:"noreferrer",underline:"always",href:"https://github.com/degorov/smart-lamp"},"Репозиторий проекта на GitHub")),n.createElement("div",null,"Application icon made by ",n.createElement(ye.Z,{target:"_blank",rel:"noreferrer",underline:"always",href:"https://www.freepik.com"},"Freepik")," from ",n.createElement(ye.Z,{target:"_blank",rel:"noreferrer",underline:"always",href:"https://www.flaticon.com/"},"www.flaticon.com")))}const xe=(0,r.Z)((e=>({root:{backgroundColor:e.palette.background.paper},icon:{marginTop:"-20px"}})));function ke({ip:e,setIp:t,setSave:a}){const l=xe(),[r,s]=(0,n.useContext)(Z),c=(0,n.useContext)(g),[i,o]=(0,n.useState)(!1),m=()=>o(!1),[u,d]=(0,n.useState)({ssid:"",password:"",showPassword:!1,timezone:3,brightness:0}),p=e=>t=>{d({...u,[e]:t.target.value}),a(v)},E=(0,n.useCallback)((async()=>{if(r){const e=await c.getsettings();e?d((t=>({...t,ssid:e.ssid,password:e.password,timezone:e.timezone,brightness:e.maxbrightness}))):s(!1)}}),[c,r,s]),v=()=>()=>{d((e=>((async()=>{await c.savesettings(e.ssid,e.password,e.timezone,e.brightness)&&o(!0),s(!1)})(),e))),a(null)};return(0,n.useEffect)((()=>(window.addEventListener("focus",E),E(),()=>{window.removeEventListener("focus",E),a(null)})),[E,a]),n.createElement(n.Fragment,null,n.createElement(X.Z,{className:l.root},n.createElement(ne.Z,null,"Подключение:"),n.createElement(Y.Z,null,n.createElement(re.Z,{id:"lamp-ip",label:"IP-адрес лампы",variant:"outlined",size:"small",value:e.address,onChange:e=>{const a=e.target.value;/^(?!0)(?!.*\.$)((1?\d?\d|25[0-5]|2[0-4]\d)(\.|$)){4}$/.test(a)?t({address:a,valid:!0}):t({address:a,valid:!1})},error:!e.valid}),n.createElement(te.Z,null,n.createElement(ie.Z,{variant:"contained",color:"primary",disabled:!e.valid,onClick:()=>s()},n.createElement(he.Z,null)))),r?n.createElement(n.Fragment,null,n.createElement(Y.Z,null,n.createElement(re.Z,{id:"ssid",label:"Имя сети",variant:"outlined",size:"small",fullWidth:!0,value:u.ssid,onChange:p("ssid")})),n.createElement(Y.Z,null,n.createElement(Ee.Z,{variant:"outlined",size:"small",fullWidth:!0},n.createElement(ge.Z,{htmlFor:"password"},"Пароль сети"),n.createElement(fe.Z,{id:"password",labelWidth:95,type:u.showPassword?"text":"password",value:u.password,onChange:p("password"),endAdornment:n.createElement(Ze.Z,{position:"end"},n.createElement(y.Z,{onClick:()=>{d({...u,showPassword:!u.showPassword})},onMouseDown:e=>{e.preventDefault()},edge:"end"},u.showPassword?n.createElement(be.Z,null):n.createElement(we.Z,null)))}))),n.createElement(ne.Z,null,"Часовой пояс:"),n.createElement(Y.Z,null,n.createElement(re.Z,{id:"timezone",select:!0,variant:"outlined",size:"small",fullWidth:!0,value:u.timezone,onChange:p("timezone")},n.createElement(ve.Z,{value:2},"МСК−1 (калининградское время)"),n.createElement(ve.Z,{value:3},"МСК (московское время)"),n.createElement(ve.Z,{value:4},"МСК+1 (самарское время)"),n.createElement(ve.Z,{value:5},"МСК+2 (екатеринбургское время)"),n.createElement(ve.Z,{value:6},"МСК+3 (омское время)"),n.createElement(ve.Z,{value:7},"МСК+4 (красноярское время)"),n.createElement(ve.Z,{value:8},"МСК+5 (иркутское время)"),n.createElement(ve.Z,{value:9},"МСК+6 (якутское время)"),n.createElement(ve.Z,{value:10},"МСК+7 (владивостокское время)"),n.createElement(ve.Z,{value:11},"МСК+8 (магаданское время)"),n.createElement(ve.Z,{value:12},"МСК+9 (камчатское время)"))),n.createElement(ne.Z,null,"Максимальная яркость:",n.createElement(x.Z,{component:"span",color:u.brightness>184?"error":"initial"}," ",u.brightness)),n.createElement(Y.Z,null,n.createElement(W.Z,{container:!0,spacing:2,alignItems:"center"},n.createElement(W.Z,{item:!0,className:l.icon},n.createElement(G.Z,null)),n.createElement(W.Z,{item:!0,xs:!0},n.createElement(_.Z,{min:72,max:255,marks:[{value:184,label:"Предел БП"}],value:u.brightness,onChange:(e,t)=>{d({...u,brightness:t}),a(v)}})),n.createElement(W.Z,{item:!0,className:l.icon},n.createElement(B.Z,null))))):null),n.createElement(Ce,null),n.createElement(oe.Z,{open:i,onClose:m},n.createElement(pe.Z,null,"Внимание!"),n.createElement(ue.Z,null,n.createElement(de.Z,null,"Для применения настроек светильник необходимо перезагрузить вручную. Отключите светильник от сети и после перезагрузки заново подключитесь к светильнику в приложении.")),n.createElement(me.Z,null,n.createElement(ie.Z,{onClick:m,color:"primary"},"ОК"))))}const Ne=(0,r.Z)((e=>({backdrop:{zIndex:e.zIndex.drawer+1,color:"#fff"},offset:{paddingBottom:e.mixins.toolbar.minHeight}}))),ze=function(){const e=Ne(),t=(0,s.Z)("(prefers-color-scheme: dark)"),a=(0,n.useMemo)((()=>(0,c.Z)({palette:{primary:{main:t?"#FFCD14":"#F55528"},secondary:{main:t?"#0AAAD7":"#008CC3"},type:t?"dark":"light"}},o.nx)),[t]),l=["Эффекты","Будильник","Настройки"],[r,w]=(0,n.useState)(!1),[y,C]=(0,n.useState)(null),[x,k]=(0,n.useState)({address:"",valid:!1}),[N,z]=(0,n.useState)(),[S,F]=(0,n.useState)(null),I=(0,n.useMemo)((()=>function(e,t){const a=async(t=(()=>localStorage.getItem("lamp-ip"))(),a)=>{if(v.dV.isNativePlatform()){const n=setTimeout((()=>e(!0)),500);try{return(await f.e.post({url:"http://".concat(t,"/"),headers:{"Content-Type":"application/json"},connectTimeout:h,readTimeout:h,data:a})).data}finally{clearTimeout(n),e(!1)}}else{const n=new AbortController,l=setTimeout((()=>n.abort()),h),r=setTimeout((()=>e(!0)),500);try{const s=await fetch("http://".concat(t,"/"),{signal:n.signal,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await s.json()}finally{clearTimeout(l),clearTimeout(r),e(!1)}}};return Object.fromEntries(Object.entries(b).map((([e,t])=>[e,t.bind(null,a)])))}(w)),[]);return(0,n.useEffect)((()=>{if(void 0===N&&!x.address&&null===y){const e=localStorage.getItem("lamp-ip");e?k({address:e,valid:!0}):z(!1)}void 0===N&&x.address&&(async()=>{await I.ping(x.address)?(localStorage.setItem("lamp-ip",x.address),z(!0)):z(!1)})(),!0===N&&null===y&&C(0),!1===N&&2!==y&&C(2)}),[I,N,x.address,y]),n.createElement(i.Z,{theme:a},n.createElement(E.ZP,null),n.createElement(p.Z,{disableGutters:!0},n.createElement(Z.Provider,{value:[N,z]},n.createElement(P,{title:l[y],save:S}),n.createElement(u.Z,{className:e.offset},n.createElement(g.Provider,{value:I},0===y?n.createElement(Q,null):1===y?n.createElement(ce,{setSave:F}):2===y?n.createElement(ke,{ip:x,setIp:k,setSave:F}):null)),n.createElement(K,{labels:l,page:y,setPage:C}))),n.createElement(m.Z,{className:e.backdrop,open:r},n.createElement(d.Z,{color:"inherit"})))};l.render(n.createElement(ze),document.getElementById("app"))}},e=>{var t=t=>e(e.s=t);e.O(0,[216],(()=>(t(3658),t(7956)))),e.O()}]);